# Soldier-Behavior-Trees

Демонстрация ИИ для солдата используя BhvTree на Unreal Engine 5.

## Дерево поведения солдата

![](BehTree.png)

## Узлы

### Задачи

#### **GetRandomPoint**
Узел, в котором вычисляется случайная точка в navMesh пространстве куда агент может потенциально встать.
* **success** - записывает в blackboard точку для потенциального перемещения.
* **failure** - не может найти точку куда navMesh агент может встать.


#### **GetNextPatrolPoint**
Узел который по порядку выбирает точку для следующего патрулирования.
* **success** - записывает в blackboard точку для потенциального перемещения.
* **failure** - Точек для патрулирования нет.


#### **ResetShootsCount**
Узел в котором количество выстрелов перезаписывается.
* **success** - счётчик выстрелов равен 0.
  * **failure** - счётчика выстрелов не существует в Blackboard.


#### **MoveTo**
Узел передающий navMesh агенту точку для передвижения.
* **success** - агент достиг цели.
* **failure** - агент не может достигнуть точки.



#### **Wait**
Узел останавливающий поток дерева поведения.
* **success** - время ожидания истекло.
* **failure** - агент не может достигнуть точки.



#### **RunAway**
Узел передающий navMesh агенту точку для передвижения, отдалённую на расстояние от точки, которую надо избегать.
* **success** - агент находится на достаточной расстоянии, считая, что он убежал.
* **failure** - агент не знает куда бежать.



#### **CheckAmmoInGun**
Узел проверяющий blackboard переменные о патронах в магазине, в инвентаре.
* **success** - проверил патроны.
* **failure** - патроны в инвентаре закончились, перезарядка невозможна.



#### **Reload**
Узел передающий команду View на перезарядку.
* **success** - анимация перезарядки произошла, магазин перезаряжен успешно.
* **failure** - патроны в инвентаре закончились, перезарядка невозможна.




#### **Rotate to face BB entry**
Поворачивает агента к точке.
* **success** - агент повернулся к цели.
* **failure** - агент не может повернуться к цели.



#### **Shoot**
Запускает анимации и логику стрельбы оружия.
* **success** - выстрел прошёл успешно.
* **failure** - выстрел невозможен.



#### **DoSlaughter**
Запускает анимации и логику атаки оружия ближнего боя.
* **success** - удар прошёл успешно.
* **failure** - удар невозможен.



### Узлы исполнения последовательности

#### **GoTo**
Узел который передвигает navMesh агента.
* **success** - агент дошёл до точки.
* **failure** - агент почему то не может дойти до точки.



#### **Shoot and wait**
Узел отвечающий за стрельбу с задержкой.
* **success** - все выстрелы были произведены.
* **failure** - не все выстрелы были произведены или выстрелов не было вовсе.



#### **Check Ammo**
Узел отвечающий за перезарядку оружия.
* **success** - оружие теперь заряжено и готово к бою.
* **failure** - оружие не было перезаряжено.



#### **Rotate and Shoot**
Узел поворачивающий модель к цели с последующей стрельбой по ней.
* **success** - выстрел по цели был произведён.
* **failure** - выстрела не было.



#### **Patrol**
Узел отвечающий за патрулирование бота и последующей реакцией на найденных врагов.
* **success** - патруль прошёл успешно.
* **failure** - что-то помешало патрулированию.


### Селекторы

#### **Выбор режима боя**
Узел, устанавливающий как будет действовать бот на видимых им врагов.
* **success** - атака произошла успешно.
* **failure** - атаке что то помешало или атаки не было вовсе.


#### **Run and Gun**
Узел, устанавливающий как будет действовать бот во время патрулирования.
* **success** - бот патрулирует.
* **failure** - что то мешает боту патрулировать.


#### **Идти в случайном направлении или по точкам**
Узел принимающий решение как идти боту - по точкам патруля или по случайно-заданной точке.
* **success** - Точка была назначена в blackboard.
* **failure** - Нету точек патруля и нету вообще какого либо места чтобы встать navMesh агенту.



#### **Reload or Shoot**
Узел управляющий поведением вовремя стрельбы бота.
* **success** - бот выстелил с оружия.
* **failure** - бот не может стрелять.

### **Параллельные узлы**

#### **Wait in place**
Узел ожидания с последующим реагированием на видимых врагов. 
* **success** - Ожидание прошло успешно.
* **failure** - Что то прервало ожидание.



### Декораторы


* **Если нет патруля А** - Условие при котором в blackboard не установлена точка патрулирования А.

* **Если нет патруля B** - Условие при котором в blackboard не установлена точка патрулирования Б.

* **Если меньше 10 выстрелов** - Условие при котором в blackboard счётчики выстрелов < 10.

* **Если враги не убиты** - Условие при котором, в случае если есть видимые враги и они не убиты.

* **Если врагов нет** - Условие при котором в blackboard количество видимых врагов равна 0.

* **Если есть враг** - Условие при котором в blackboard количество видимых врагов не равна 0.

* **Если ХП > 20%** - Условие при котором в blackboard процентное соотношение здоровья актёра > 20%.

* **Если ХП < 20%** - Условие при котором в blackboard процентное соотношение здоровья актёра < 20%.

* **Если есть патроны в инвентаре** - Условие при котором в blackboard переменная количества патрон данного типа оружия в инвентаре не равно 0.

* **Если нет патрон в магазине** - Условие при котором в blackboard переменная количества патрон в магазине равна 0.

* **Если нужно перезарядится** - Условие при котором в blackboard булева переменная IsRequreReload является правдой.


### Переменные Blackboard

* **ClosestEnemyPosition** - Vector - ближайшая позиция потенциального противника.

* **VisibleEnemies** - Int - количество видимых противников.

* **IsRequreReload** - Bool - нужна ли перезарядка?

* **HP** - Float - процентное соотношение здоровья актёра бота.

* **AmmoInGun** - Int - сколько патрон в магазине текущего оружия.

* **IsMelee** - Bool - является юнитом ближнего боя.

* **AmmoInInventory** - Int - патроны для текущего оружия в инвентаре.

* **AllowableAmmoInMagazine** - Int - сколько патрон в магазине текущего оружия может быть.

* **PatrolPointA** - Vector - точка патрулирования А.

* **PatrolPointB** - Vector - точка патрулирования Б.

* **CurrentPatrolPoint** - Vector - текущая позиция патрулирования.

* **ShootCount** - Int - сколько выстрелов было сделано.

* **EnemiesKilled** - Bool - был ли убит враг.
